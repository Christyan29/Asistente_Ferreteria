"""
Vista del Asistente Virtual.
Interfaz de chat para interactuar con el asistente (versi√≥n b√°sica sin IA).
"""
from PyQt5.QtWidgets import (
    QWidget, QVBoxLayout, QHBoxLayout, QPushButton, QTextEdit,
    QLineEdit, QLabel, QTextBrowser, QMessageBox
)
from PyQt5.QtCore import Qt, pyqtSignal
from PyQt5.QtGui import QTextCursor
from datetime import datetime
import logging

from app.presentation.components.avatar_widget import AvatarWidget
from app.infrastructure.product_repository import ProductRepository
from app.services.groq_service import get_groq_service

logger = logging.getLogger(__name__)


class AsistenteView(QWidget):
    """Vista del asistente virtual con chat b√°sico"""

    # Se√±ales
    mensaje_enviado = pyqtSignal(str)

    def __init__(self, parent=None):
        super().__init__(parent)
        self.producto_repo = ProductRepository()
        self.groq_service = get_groq_service()
        self.conversation_history = []
        self.setup_ui()
        self.mostrar_mensaje_bienvenida()

    def setup_ui(self):
        """Configura la interfaz de usuario"""
        layout = QHBoxLayout(self)
        layout.setSpacing(20)
        layout.setContentsMargins(20, 20, 20, 20)

        # Panel izquierdo: Avatar
        left_panel = self.create_avatar_panel()
        layout.addWidget(left_panel, stretch=1)

        # Panel derecho: Chat
        right_panel = self.create_chat_panel()
        layout.addWidget(right_panel, stretch=2)

    def create_avatar_panel(self):
        """Crea el panel del avatar"""
        panel = QWidget()
        layout = QVBoxLayout(panel)
        layout.setAlignment(Qt.AlignTop | Qt.AlignCenter)

        # T√≠tulo con nombre Gabo
        title = QLabel("Gabo")
        title.setObjectName("titleLabel")
        title.setAlignment(Qt.AlignCenter)
        title.setStyleSheet("font-size: 32pt; font-weight: 700; color: #2d3748;")
        layout.addWidget(title)

        subtitle = QLabel("Tu asistente virtual")
        subtitle.setAlignment(Qt.AlignCenter)
        subtitle.setStyleSheet("font-size: 12pt; color: #718096; margin-bottom: 10px;")
        layout.addWidget(subtitle)

        # Avatar
        self.avatar = AvatarWidget()
        layout.addWidget(self.avatar, alignment=Qt.AlignCenter)

        # Informaci√≥n
        info_label = QLabel("¬øEn qu√© puedo ayudarte hoy?")
        info_label.setAlignment(Qt.AlignCenter)
        info_label.setStyleSheet("color: #6b6b65; font-size: 11pt;")
        layout.addWidget(info_label)

        layout.addStretch()

        # Nota sobre IA
        if self.groq_service.is_available():
            note = QLabel("ü§ñ IA Activa (Groq - Ultra R√°pido)")
            note.setStyleSheet("color: #6ba56a; font-size: 9pt; padding: 8px; background-color: #f0faf0; border-radius: 8px;")
        else:
            note = QLabel("‚ÑπÔ∏è Modo b√°sico (sin IA)")
            note.setStyleSheet("color: #d68a6e; font-size: 9pt; padding: 8px; background-color: #fef5f1; border-radius: 8px;")
        note.setAlignment(Qt.AlignCenter)
        layout.addWidget(note)

        return panel

    def create_chat_panel(self):
        """Crea el panel de chat"""
        panel = QWidget()
        layout = QVBoxLayout(panel)

        # T√≠tulo del chat
        chat_title = QLabel("üí¨ Conversaci√≥n")
        chat_title.setObjectName("subtitleLabel")
        layout.addWidget(chat_title)

        # √Årea de mensajes
        self.chat_display = QTextBrowser()
        self.chat_display.setObjectName("chatDisplay")
        self.chat_display.setOpenExternalLinks(False)
        layout.addWidget(self.chat_display)

        # √Årea de entrada
        input_layout = self.create_input_area()
        layout.addLayout(input_layout)

        # Sugerencias r√°pidas
        suggestions_layout = self.create_suggestions()
        layout.addLayout(suggestions_layout)

        return panel

    def create_input_area(self):
        """Crea el √°rea de entrada de mensajes"""
        layout = QHBoxLayout()

        # Campo de texto
        self.message_input = QLineEdit()
        self.message_input.setPlaceholderText("Escribe tu pregunta aqu√≠...")
        self.message_input.returnPressed.connect(self.enviar_mensaje)
        layout.addWidget(self.message_input, stretch=4)

        # Bot√≥n de voz (deshabilitado por ahora)
        self.btn_voz = QPushButton("üé§")
        self.btn_voz.setToolTip("Entrada por voz (pr√≥ximamente)")
        self.btn_voz.setEnabled(False)
        self.btn_voz.setMaximumWidth(50)
        layout.addWidget(self.btn_voz)

        # Bot√≥n enviar
        self.btn_enviar = QPushButton("Enviar")
        self.btn_enviar.setObjectName("primaryButton")
        self.btn_enviar.clicked.connect(self.enviar_mensaje)
        layout.addWidget(self.btn_enviar)

        return layout

    def create_suggestions(self):
        """Crea botones de sugerencias r√°pidas"""
        layout = QHBoxLayout()

        label = QLabel("Sugerencias:")
        label.setStyleSheet("color: #718096; font-size: 10pt; font-weight: 600;")
        layout.addWidget(label)

        suggestions = [
            "¬øQu√© productos tienes?",
            "Productos con stock bajo",
            "Buscar martillo",
            "Categor√≠as disponibles"
        ]

        for suggestion in suggestions:
            btn = QPushButton(suggestion)
            btn.setStyleSheet("""
                QPushButton {
                    background-color: #ffffff;
                    color: #4a5568;
                    border: 1.5px solid #e2e8f0;
                    border-radius: 12px;
                    padding: 8px 16px;
                    font-size: 10pt;
                }
                QPushButton:hover {
                    background-color: #f7fafc;
                    border-color: #cbd5e0;
                }
            """)
            btn.clicked.connect(lambda checked, s=suggestion: self.usar_sugerencia(s))
            layout.addWidget(btn)

        layout.addStretch()
        return layout

    def mostrar_mensaje_bienvenida(self):
        """Muestra el mensaje de bienvenida"""
        mensaje = """
        <div style='background-color: #fafaf8; padding: 20px; border-radius: 16px; margin: 10px 0; border: 1.5px solid #d4d4ce;'>
            <p style='color: #2b2825; font-weight: 600; font-size: 13pt; margin: 0 0 12px 0;'>üëã ¬°Hola! Soy Gabo, tu asistente virtual de Ferreter√≠a Disensa. Puedo ayudarte a buscar productos, consultar disponibilidad y brindarte informaci√≥n sobre nuestros art√≠culos.</p>
        </div>
        """
        self.chat_display.append(mensaje)

    def agregar_mensaje_usuario(self, texto):
        """Agrega un mensaje del usuario al chat"""
        timestamp = datetime.now().strftime("%H:%M")
        mensaje = f"""
        <div style='text-align: right; margin: 10px 0;'>
            <div style='display: inline-block; background-color: #cc785c; color: #ffffff;
                        padding: 12px 18px; border-radius: 16px; max-width: 70%;'>
                <p style='margin: 0; font-weight: 500;'>{texto}</p>
                <p style='margin: 5px 0 0 0; font-size: 8pt; opacity: 0.9;'>{timestamp}</p>
            </div>
        </div>
        """
        self.chat_display.append(mensaje)
        self.chat_display.moveCursor(QTextCursor.End)

    def agregar_mensaje_asistente(self, texto):
        """Agrega un mensaje del asistente al chat"""
        timestamp = datetime.now().strftime("%H:%M")
        mensaje = f"""
        <div style='text-align: left; margin: 10px 0;'>
            <div style='display: inline-block; background-color: #fafaf8; color: #2b2825;
                        padding: 12px 18px; border-radius: 16px; max-width: 70%; border: 1px solid #d4d4ce;'>
                <p style='margin: 0;'>{texto}</p>
                <p style='margin: 5px 0 0 0; font-size: 8pt; opacity: 0.7; color: #6b6b65;'>{timestamp}</p>
            </div>
        </div>
        """
        self.chat_display.append(mensaje)
        self.chat_display.moveCursor(QTextCursor.End)

    def usar_sugerencia(self, sugerencia):
        """Usa una sugerencia r√°pida"""
        self.message_input.setText(sugerencia)
        self.enviar_mensaje()

    def enviar_mensaje(self):
        """Env√≠a un mensaje y procesa la respuesta"""
        mensaje = self.message_input.text().strip()
        if not mensaje:
            return

        # Limpiar input
        self.message_input.clear()

        # Mostrar mensaje del usuario
        self.agregar_mensaje_usuario(mensaje)

        # Cambiar estado del avatar
        self.avatar.start_thinking()

        # Procesar mensaje y generar respuesta
        respuesta = self.procesar_mensaje(mensaje)

        # Mostrar respuesta
        self.agregar_mensaje_asistente(respuesta)

        # Volver a estado idle
        self.avatar.stop()

        # Emitir se√±al
        self.mensaje_enviado.emit(mensaje)

    def procesar_mensaje(self, mensaje):
        """
        Procesa el mensaje del usuario y genera una respuesta.
        Usa Gemini AI si est√° disponible, sino usa modo b√°sico.
        """
        try:
            # Intentar usar Gemini AI primero
            if self.groq_service.is_available():
                return self.procesar_con_groq(mensaje)
            else:
                # Fallback a modo b√°sico
                return self.procesar_modo_basico(mensaje)
        except Exception as e:
            logger.error(f"Error al procesar mensaje: {e}")
            # Si falla Gemini, intentar modo b√°sico
        """
        mensaje_lower = mensaje.lower()

        try:
            # Comandos espec√≠ficos con m√°s variaciones
            if any(palabra in mensaje_lower for palabra in ["stock bajo", "stock m√≠nimo", "poco stock", "productos bajos"]):
                return self.responder_stock_bajo()

            elif any(palabra in mensaje_lower for palabra in ["categor√≠a", "categorias", "tipos de productos", "secciones"]):
                return self.responder_categorias()

            elif any(palabra in mensaje_lower for palabra in ["cu√°ntos productos", "total", "cantidad", "qu√© productos tienes", "que productos", "productos disponibles"]):
                return self.responder_total_productos()

            elif any(palabra in mensaje_lower for palabra in ["buscar", "busca", "necesito", "quiero", "tienes", "tienen", "hay"]):
                # Extraer t√©rmino de b√∫squeda - remover palabras comunes
                palabras_ignorar = ["buscar", "busca", "necesito", "quiero", "tienes", "tienen", "hay", "un", "una", "el", "la", "los", "las", "de", "para"]
                palabras = mensaje_lower.split()
                terminos = [p for p in palabras if p not in palabras_ignorar and len(p) > 2]

                if terminos:
                    termino = " ".join(terminos)
                    return self.responder_busqueda(termino)
                else:
                    # Si no hay t√©rminos espec√≠ficos, mostrar productos
                    return self.responder_total_productos()

            # B√∫squeda general por palabras clave
            else:
                return self.responder_busqueda(mensaje)

        except Exception as e:
            logger.error(f"Error al procesar mensaje en modo b√°sico: {e}")
            return "Lo siento, ocurri√≥ un error al procesar tu consulta. Por favor, intenta de nuevo."

    def responder_stock_bajo(self):
        """Responde con productos de stock bajo"""
        productos = self.producto_repo.get_stock_bajo()

        if not productos:
            return "‚úÖ ¬°Excelente! No hay productos con stock bajo en este momento."

        respuesta = f"‚ö†Ô∏è Encontr√© {len(productos)} producto(s) con stock bajo:<br><br>"
        for p in productos[:5]:  # M√°ximo 5
            respuesta += f"‚Ä¢ <b>{p.nombre}</b>: {p.stock} {p.unidad_medida} (m√≠nimo: {p.stock_minimo})<br>"

        if len(productos) > 5:
            respuesta += f"<br>... y {len(productos) - 5} m√°s."

        return respuesta

    def responder_categorias(self):
        """Responde con las categor√≠as disponibles"""
        from app.infrastructure.product_repository import CategoriaRepository
        cat_repo = CategoriaRepository()
        categorias = cat_repo.get_all()

        if not categorias:
            return "No hay categor√≠as registradas en el sistema."

        respuesta = f"üìÅ Tenemos {len(categorias)} categor√≠as disponibles:<br><br>"
        for cat in categorias:
            respuesta += f"‚Ä¢ <b>{cat.nombre}</b>"
            if cat.descripcion:
                respuesta += f": {cat.descripcion}"
            respuesta += "<br>"

        return respuesta

    def responder_total_productos(self):
        """Responde con el total de productos"""
        productos = self.producto_repo.get_all()
        return f"üì¶ Actualmente tenemos <b>{len(productos)} productos</b> registrados en el inventario."

    def responder_busqueda(self, termino):
        """Responde con resultados de b√∫squeda"""
        productos = self.producto_repo.search(termino)

        if not productos:
            return f"‚ùå No encontr√© productos que coincidan con '<b>{termino}</b>'. Intenta con otro t√©rmino de b√∫squeda."

        respuesta = f"üîç Encontr√© {len(productos)} producto(s) relacionado(s) con '<b>{termino}</b>':<br><br>"

        for p in productos[:5]:  # M√°ximo 5 resultados
            respuesta += f"‚Ä¢ <b>{p.nombre}</b><br>"
            if p.marca:
                respuesta += f"  Marca: {p.marca}<br>"
            respuesta += f"  Precio: {p.precio_formateado} | Stock: {p.stock} {p.unidad_medida}"
            if p.stock_bajo:
                respuesta += " ‚ö†Ô∏è"
            respuesta += "<br><br>"

        if len(productos) > 5:
            respuesta += f"... y {len(productos) - 5} producto(s) m√°s."

        return respuesta

    def limpiar_chat(self):
        """Limpia el historial del chat"""
        self.chat_display.clear()
        self.conversation_history.clear()
        if self.groq_service.is_available():
            self.groq_service.clear_history()
        self.mostrar_mensaje_bienvenida()
